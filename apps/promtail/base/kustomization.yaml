apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: monitoring
helmCharts:
  - name: promtail
    includeCRDs: true
    releaseName: promtail
    version: 6.15.3
    repo: https://grafana.github.io/helm-charts
    valuesInline:
      fullnameOverride: promtail
      serviceMonitor:
        enabled: true
        additionalLabels:
          app: prometheus-operator
          release: prometheus
      config:
        clients:
          - url: http://loki-gateway.monitoring/loki/api/v1/push

        snippets:
          pipelineStages:
            - cri: {}
            - drop:
                source: "container"
                expression: "istio-proxy"
            - match:
                selector: '{app="hotrod"}'
                stages:
                  - regex:
                      expression: ".*(?P<trace>trace_id\"\\S)\\s\"(?P<traceID>[a-zA-Z\\d]+).*"
                      traceID: traceID
                  - labels:
                      traceID:
            - logfmt:
                mapping:
                  time:
                  level:
                  particle_id:
                source: message
            - json:
                expressions:
                  time: '"@timestamp"'
                  message: message
                  level: level
                  service: service
                  type: type
                  plugin: plugin
            - labels:
                level: level
                service: service
                type: type
                plugin: plugin
            - timestamp:
                format: RFC3339
                source: "time"
            - output:
                source: message
          # common:
          #   - action: replace
          #     source_labels:
          #       - __meta_kubernetes_pod_node_name
          #     target_label: node_name
          #   - action: replace
          #     source_labels:
          #       - __meta_kubernetes_namespace
          #     target_label: namespace
          #   - action: replace
          #     replacement: $1
          #     separator: /
          #     source_labels:
          #       - namespace
          #       - app
          #     target_label: job
          #   - action: replace
          #     source_labels:
          #       - __meta_kubernetes_pod_name
          #     target_label: pod
          #   - action: replace
          #     source_labels:
          #       - __meta_kubernetes_pod_container_name
          #     target_label: container
          #   - action: replace
          #     replacement: /var/log/pods/*$1/*.log
          #     separator: /
          #     source_labels:
          #       - __meta_kubernetes_pod_uid
          #       - __meta_kubernetes_pod_container_name
          #     target_label: __path__
          #   - action: replace
          #     replacement: /var/log/pods/*$1/*.log
          #     regex: true/(.*)
          #     separator: /
          #     source_labels:
          #       - __meta_kubernetes_pod_annotationpresent_kubernetes_io_config_hash
          #       - __meta_kubernetes_pod_annotation_kubernetes_io_config_hash
          #       - __meta_kubernetes_pod_container_name
          #     target_label: __path__
