apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: tracing
helmCharts:
  - name: opentelemetry-collector
    includeCRDs: true
    releaseName: open-telemetry
    version: 0.73.1
    repo: https://open-telemetry.github.io/opentelemetry-helm-charts
    valuesInline:
      mode: deployment
      fullnameOverride: opentelemetry-collector
      presets:
        hostMetrics:
          enabled: true
      serviceMonitor:
        enabled: true
      ports:
        metrics:
          enabled: true
      config:
        extensions:
          health_check: {}
          memory_ballast:
            size_in_percentage: 40
        connectors:
          spanmetrics: {}

        receivers:
          otlp:
            protocols:
              grpc:
                endpoint: ${env:MY_POD_IP}:4317
              http:
                endpoint: ${env:MY_POD_IP}:4318
          prometheus:
            config:
              scrape_configs:
                - job_name: opentelemetry-collector
                  scrape_interval: 10s
                  static_configs:
                    - targets:
                        - ${env:MY_POD_IP}:8888
          zipkin:
            endpoint: ${MY_POD_IP}:9411

        processors:
          batch: {}
          memory_limiter:
            check_interval: 5s
            limit_percentage: 80
            spike_limit_percentage: 25
          spanmetrics:
            metrics_exporter: prometheus

        exporters:
          otlp/jaeger:
            endpoint: "jaeger-collector.observability.svc:4317"
            tls:
              insecure: true
          prometheus:
            enable_open_metrics: true
            endpoint: 0.0.0.0:9464
            resource_to_telemetry_conversion:
              enabled: true
          # prometheusremotewrite:
          #   endpoint: http://prometheus-prometheus-pushgateway.monitoring.svc.cluster.local:9091/api/v1/write
          #   external_labels:
          #     job: opentelemetry-collectors
          #     cluster: dev

        service:
          extensions: [health_check, memory_ballast]
          pipelines:
            traces:
              receivers: [otlp, jaeger, zipkin]
              processors: [batch, spanmetrics, memory_limiter]
              exporters: [otlp/jaeger]
            metrics:
              receivers: [otlp, prometheus, memory_limiter]
              exporters: [prometheus]
