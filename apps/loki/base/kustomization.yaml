apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: monitoring
helmCharts:
  - name: loki
    includeCRDs: true
    releaseName: loki
    namespace: monitoring
    version: 5.35.0 #2.9.11
    repo: https://grafana.github.io/helm-charts
    valuesInline:
      labels:
        app: loki
      # minio:
      #   enabled: true
      #   buckets:
      #     - name: admin
      #       policy: none
      #       purge: false
      #     - name: chunks
      #       policy: none
      #       purge: false
      #     - name: data
      #       policy: none
      #       purge: false
      #     - name: ruler
      #       policy: none
      #       purge: false
      tracing:
        jaegerAgentHost: jaeger-collector.observability.svc.cluster.local:9411
      persistence:
        enabled: true
      loki:
        # TODO auth? technically don't need it, but would be cool
        auth_enabled: false

        compactor:
          shared_store: aws

        schema_config:
          configs:
            - from: 2020-10-24
              store: boltdb-shipper
              object_store: aws
              schema: v12
              index:
                prefix: loki_index_
                period: 24h

        storage_config:
          aws:
            s3: "s3://us-east-1/devxp-dev-loki-logs"
          boltdb_shipper:
            shared_store: aws

          # boltdb_shipper:
          #   active_index_directory: /loki/index
          #   shared_store: s3
          #   cache_location: /loki/boltdb-cache
          # endpoint: loki-minio.monitoring.svc:9000
          # insecure: true
          # bucketnames: data
          # s3forcepathstyle: true

        # storage:
        #   # type: s3
        #   s3:
        #     endpoint: loki-minio.monitoring.svc:9000
        #     region: us-east-1
        #     s3ForcePathStyle: true
        #     insecure: false
        #   bucketNames:
        #     admin: admin
        #     chunks: chunks
        #     ruler: ruler
        # server:
        #   log_level: warn
      # backend:
      #   # persistence:
      #   # enableStatefulSetAutoDeletePVC: false
      #   # volumeClaimsEnabled: false
      #   extraArgs:
      #     - -config.expand-env=true
      #   affinity: {}
      #   extraEnvFrom:
      #     - secretRef:
      #         name: loki-minio
      # read:
      #   extraArgs:
      #     - -config.expand-env=true
      #   affinity: {}
      #   extraEnvFrom:
      #     - secretRef:
      #         name: loki-minio
      # write:
      #   extraArgs:
      #     - -config.expand-env=true
      #   affinity: {}
      #   extraEnvFrom:
      #     - secretRef:
      #         name: loki-minio
      # tableManager:
      #   enabled: true
      #   extraArgs:
      #     - -config.expand-env=true
      #   affinity: {}
      #   extraEnvFrom:
      #     - secretRef:
      #         name: loki-minio
      #   retention_deletes_enabled: true
      #   retention_period: 168h
      monitoring:
        selfMonitoring:
          enabled: false
          grafanaAgent:
            installOperator: false
      test:
        enabled: false
