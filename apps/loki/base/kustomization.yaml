apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: monitoring
helmCharts:
  - name: loki-stack
    includeCRDs: true
    releaseName: loki-stack
    namespace: monitoring
    version: 2.9.11
    repo: https://grafana.github.io/helm-charts
    valuesInline:
      # nameOverride: loki-stack
      # global:
      #   dnsService: coredns
      #   clusterDomain: cluster.local
      labels:
        app: loki
      loki:
        distributorLabels:
          app: loki
        serviceAccount:
          annotations:
            eks.amazonaws.com/role-arn: "arn:aws:iam::239468932737:role/loki-stack-lgseksd1-sa"
          automountServiceAccountToken: true

        auth_enabled: false

        structuredConfig:
          ingester:
            # Disable chunk transfer which is not possible with statefulsets
            # and unnecessary for boltdb-shipper
            max_transfer_retries: 0
            chunk_idle_period: 1h
            chunk_target_size: 1536000
            max_chunk_age: 1h

        # Doc: https://github.com/grafana/loki/blob/main/docs/sources/configuration/examples.md#aws-basic-config-no-credsyaml
        # Doc: https://grafana.com/docs/loki/latest/operations/storage/boltdb-shipper/#example-configuration
        # Using S3 for chunk storage
        schemaConfig:
          configs:
            - from: "2020-09-07"
              store: boltdb-shipper
              object_store: aws
              schema: v11
              index:
                prefix: index_
                period: 24h
        storage_config:
          aws:
            s3: s3://us-east-1/devxp-dev-loki-logs
          boltdb_shipper:
            active_index_directory: /loki/index
            shared_store: s3
            cache_location: /loki/boltdb-cache

        distributor:
          autoscaling:
            enabled: true
            maxReplicas: 1
            minReplicas: 1

        ingester:
          autoscaling:
            enabled: true
            maxReplicas: 1
            minReplicas: 1
          # Extra emtpyDir for the Loki's boltdb_shipper usage
          # Source: https://github.com/grafana/loki/issues/4466#issuecomment-1078960849
          extraVolumes:
            - name: boltdb-shipper
              emptyDir: {}
          extraVolumeMounts:
            - name: boltdb-shipper
              mountPath: /loki

        querier:
          autoscaling:
            enabled: true
            maxReplicas: 1
            minReplicas: 1
          # Extra emtpyDir for the Loki's boltdb_shipper usage
          # Source: https://github.com/grafana/loki/issues/4466#issuecomment-1078960849
          extraVolumes:
            - name: boltdb-shipper
              emptyDir: {}
          extraVolumeMounts:
            - name: boltdb-shipper
              mountPath: /loki

        queryFrontend:
          autoscaling:
            enabled: true
            maxReplicas: 1
            minReplicas: 1
