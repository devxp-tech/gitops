apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: monitoring
helmCharts:
  - name: loki
    includeCRDs: true
    releaseName: loki
    namespace: monitoring
    version: 5.35.0 #2.9.11
    repo: https://grafana.github.io/helm-charts
    valuesInline:
      labels:
        app: loki
      # minio:
      #   enabled: true
      #   buckets:
      #     - name: admin
      #       policy: none
      #       purge: false
      #     - name: chunks
      #       policy: none
      #       purge: false
      #     - name: data
      #       policy: none
      #       purge: false
      #     - name: ruler
      #       policy: none
      #       purge: false
      tracing:
        jaegerAgentHost: jaeger-collector.observability.svc.cluster.local:9411
      loki:
        # TODO auth? technically don't need it, but would be cool
        auth_enabled: false
        schema_config:
          configs:
            - from: 2020-10-24
              store: boltdb-shipper
              object_store: filesystem
              schema: v11
              index:
                prefix: index_
                period: 24h
        storage_config:
          aws:
            bucketnames: devxp-dev-loki-logs
            region: us-east-1
            insecure: false
            sse_encryption: false
            http_config:
              idle_conn_timeout: 90s
              response_header_timeout: 0s
              insecure_skip_verify: false
            s3forcepathstyle: true
            # endpoint: loki-minio.monitoring.svc:9000
            # insecure: true
            # bucketnames: data
            # s3forcepathstyle: true

          boltdb_shipper:
            active_index_directory: /data/loki/boltdb-shipper-active
            cache_location: /data/loki/boltdb-shipper-cache
            cache_ttl: 24h
            shared_store: s3

        chunk_store_config:
          max_look_back_period: 720h
        table_manager:
          retention_deletes_enabled: true
          retention_period: 720h
        compactor:
          working_directory: /data/loki/boltdb-shipper-compactor
          shared_store: s3

        # storage:
        #   # type: s3
        #   s3:
        #     endpoint: loki-minio.monitoring.svc:9000
        #     region: us-east-1
        #     s3ForcePathStyle: true
        #     insecure: false
        #   bucketNames:
        #     admin: admin
        #     chunks: chunks
        #     ruler: ruler
        # server:
        #   log_level: warn
      # backend:
      #   # persistence:
      #   # enableStatefulSetAutoDeletePVC: false
      #   # volumeClaimsEnabled: false
      #   extraArgs:
      #     - -config.expand-env=true
      #   affinity: {}
      #   extraEnvFrom:
      #     - secretRef:
      #         name: loki-minio
      # read:
      #   extraArgs:
      #     - -config.expand-env=true
      #   affinity: {}
      #   extraEnvFrom:
      #     - secretRef:
      #         name: loki-minio
      # write:
      #   extraArgs:
      #     - -config.expand-env=true
      #   affinity: {}
      #   extraEnvFrom:
      #     - secretRef:
      #         name: loki-minio
      # tableManager:
      #   enabled: true
      #   extraArgs:
      #     - -config.expand-env=true
      #   affinity: {}
      #   extraEnvFrom:
      #     - secretRef:
      #         name: loki-minio
      #   retention_deletes_enabled: true
      #   retention_period: 168h
      monitoring:
        selfMonitoring:
          enabled: false
          grafanaAgent:
            installOperator: false
      test:
        enabled: false
