apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: monitoring
helmCharts:
  - name: loki
    includeCRDs: true
    releaseName: loki
    namespace: monitoring
    version: 5.35.0 #2.9.11
    repo: https://grafana.github.io/helm-charts
    valuesInline:
      labels:
        app: loki
      minio:
        enabled: true
      tracing:
        jaegerAgentHost: jaeger-collector.observability.svc.cluster.local:9411
      loki:
        schema_config:
          configs:
            - from: 2021-08-01
              store: tsdb
              object_store: s3
              schema: v12
              index:
                prefix: index_
                period: 24h
        storage:
          bucketNames:
            admin: admin
            chunks: chunks
            ruler: ruler
          type: s3
          s3:
            endpoint: loki-minio.monitoring.svc:9000
            region: us-east-1
            s3ForcePathStyle: true
            insecure: false
        server:
          log_level: warn
        # TODO auth? technically don't need it, but would be cool
        auth_enabled: false
      backend:
        persistence:
          # enableStatefulSetAutoDeletePVC: false
          volumeClaimsEnabled: false
        extraArgs:
          - -config.expand-env=true
        affinity: {}
        extraEnvFrom:
          - secretRef:
              name: loki-minio
      read:
        extraArgs:
          - -config.expand-env=true
        affinity: {}
        extraEnvFrom:
          - secretRef:
              name: loki-minio
      write:
        extraArgs:
          - -config.expand-env=true
        affinity: {}
        extraEnvFrom:
          - secretRef:
              name: loki-minio
      tableManager:
        enabled: true
        extraArgs:
          - -config.expand-env=true
        affinity: {}
        extraEnvFrom:
          - secretRef:
              name: loki-minio
        retention_deletes_enabled: true
        retention_period: 168h
      monitoring:
        selfMonitoring:
          enabled: false
          grafanaAgent:
            installOperator: false
      test:
        enabled: false
