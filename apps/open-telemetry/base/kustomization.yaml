apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: tracing
helmCharts:
  - name: opentelemetry-collector
    includeCRDs: true
    releaseName: open-telemetry
    version: 0.73.1
    repo: https://open-telemetry.github.io/opentelemetry-helm-charts
    valuesInline:
      mode: deployment
      fullnameOverride: opentelemetry-collector
      presets:
        hostMetrics:
          enabled: true
      serviceMonitor:
        enabled: true
      ports:
        metrics:
          enabled: true
      config:
        receivers:
          jaeger:
            protocols:
              grpc:
                endpoint: ${env:MY_POD_IP}:14250
              thrift_http:
                endpoint: ${env:MY_POD_IP}:14268
              thrift_compact:
                endpoint: ${env:MY_POD_IP}:6831
          otlp:
            protocols:
              grpc:
                endpoint: ${env:MY_POD_IP}:4317
              http:
                endpoint: ${env:MY_POD_IP}:4318
          otlp/spanmetrics:
            protocols:
              grpc:
                endpoint: 0.0.0.0:12346

        processors:
          batch:
          spanmetrics:
            metrics_exporter: prometheus
            latency_histogram_buckets:
              [
                200ms,
                400ms,
                800ms,
                1s,
                1200ms,
                1400ms,
                1600ms,
                1800ms,
                2s,
                5s,
                7s,
              ]

        extensions:
          health_check: {}
          memory_ballast: {}

        exporters:
          otlp:
            endpoint: "jaeger-collector.observability.svc:4317"
            tls:
              insecure: true
          prometheus:
            endpoint: 0.0.0.0:8889
            metric_expiration: 1440m

        service:
          # telemetry:
          #   metrics:
          #     address: ${env:MY_POD_IP}:8888
          # extensions: [health_check, memory_ballast]
          pipelines:
            traces:
              receivers: [jaeger, otlp]
              processors: [spanmetrics, batch]
              exporters: [otlp]
            metrics:
              receivers: [otlp, otlp/spanmetrics]
              processors: [batch]
              exporters: [prometheus]
            # logs:
            #   receivers: [otlp]
            #   exporters: [loki]
