apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: tracing
helmCharts:
  - name: opentelemetry-collector
    includeCRDs: true
    releaseName: open-telemetry
    version: 0.73.1
    repo: https://open-telemetry.github.io/opentelemetry-helm-charts
    valuesInline:
      mode: deployment
      fullnameOverride: opentelemetry-collector
      presets:
        hostMetrics:
          enabled: true
      serviceMonitor:
        enabled: true
      ports:
        metrics:
          enabled: true
      config:
        receivers:
          jaeger:
            protocols:
              grpc:
                endpoint: ${env:MY_POD_IP}:14250
              thrift_http:
                endpoint: ${env:MY_POD_IP}:14268
              thrift_compact:
                endpoint: ${env:MY_POD_IP}:6831
          otlp:
            protocols:
              grpc:
                endpoint: ${env:MY_POD_IP}:4317
              http:
                endpoint: ${env:MY_POD_IP}:4318
          prometheus:
            config:
              scrape_configs:
                - job_name: opentelemetry-collector
                  scrape_interval: 10s
                  static_configs:
                    - targets:
                        - ${env:MY_POD_IP}:8888
        processors:
          batch:

        extensions:
          health_check: {}
          memory_ballast: {}

        exporters:
          loki:
            endpoint: http://loki-gateway.monitoring/loki/api/v1/push
            tls:
              insecure: true
          otlp:
            endpoint: "jaeger-collector.observability.svc:4317"
            tls:
              insecure: true
          prometheusremotewrite:
            endpoint: "https://prometheus-server.monitoring.svc:9009/api/v1/push"
            external_labels:
              foo: bar

        connectors:
          spanmetrics:
            histogram:
              explicit:
                buckets: [100us, 1ms, 2ms, 6ms, 10ms, 100ms, 250ms]
            dimensions:
              - name: http.method
                default: GET
              - name: http.status_code
            exemplars:
              enabled: true
            exclude_dimensions: ["status.code"]
            dimensions_cache_size: 1000
            aggregation_temporality: "AGGREGATION_TEMPORALITY_CUMULATIVE"
            metrics_flush_interval: 15s

        service:
          telemetry:
            metrics:
              address: ${env:MY_POD_IP}:8888
          extensions: [health_check, memory_ballast]
          pipelines:
            metrics:
              receivers: [otlp, prometheus]
              processors: [batch]
              exporters: [logging, prometheusremotewrite, spanmetrics]
            traces:
              receivers: [jaeger, otlp]
              processors: [batch]
              exporters: [logging, otlp, spanmetrics]
            logs:
              receivers: [otlp]
              exporters: [loki]
