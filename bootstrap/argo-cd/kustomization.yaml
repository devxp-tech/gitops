apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: argocd
# components: # Comment on Disaster Recovery
#   - https://github.com/argoproj-labs/argocd-extensions/manifests # Comment on Disaster Recovery
resources:
  - github.com/argoproj-labs/argocd-autopilot/manifests/base?ref=v0.4.17
  - https://raw.githubusercontent.com/argoproj-labs/rollout-extension/v0.3.3/manifests/install.yaml # Comment on Disaster Recovery
  - argocd-notifications-secret-sealed.yaml # Comment on Disaster Recovery
  - secrets.yaml # Comment on Disaster Recovery
  #- service-monitor.yaml # Comment on Disaster Recovery
  #- virtual-service.yaml # Comment on Disaster Recovery
patches:
# - path: argocd-server.yaml # Comment on Disaster Recovery
  - target:
      kind: Deployment
      name: argocd-applicationset-controller
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent
  - target:
      kind: Deployment
      name: argocd-notifications-controller
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent
  - target:
      kind: Deployment
      name: argocd-redis
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent
  - target:
      kind: Deployment
      name: argocd-dex-server
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent
      - op: replace
        path: /spec/template/spec/initContainers/0/imagePullPolicy
        value: IfNotPresent
  - patch: |-
      apiVersion: v1
      kind: Secret
      type: Opaque
      metadata:
        name: argocd-notifications-secret
        annotations:
          sealedsecrets.bitnami.com/managed: "true"
  - path: argocd-notifications-cm.yaml
configMapGenerator:
  - name: argocd-cmd-params-cm
    behavior: merge
    literals:
      - server.insecure="true"
      - dexserver.disable.tls="true"
      - server.dex.server="http://argocd-dex-server:5556"
      - server.dex.server.strict.tls="false"
  - name: argocd-cm
    options:
      labels:
        app.kubernetes.io/part-of: argocd
    behavior: merge
    files:
      # - files/dex.config # Comment on Disaster Recovery
      - files/repositories
      - files/repository.credentials
      - files/resource.customizations
    literals:
      - admin.enabled=true
      - kustomize.buildOptions="--enable-alpha-plugins --enable-helm --load-restrictor
        LoadRestrictionsNone"
      # - statusbadge.enabled=true # Comment on Disaster Recovery
      # - url=https://argocd.devxp-tech.io # Comment on Disaster Recovery
      # - dexserver.disable.tls=true # Comment on Disaster Recovery
      # - accounts.backstage="apiKey, login" # Comment on Disaster Recovery
  - name: argocd-rbac-cm
    options:
      labels:
        app.kubernetes.io/part-of: argocd
    behavior: merge
    files:
      - files/policy.csv
    literals:
      - policy.default="role:readonly"

